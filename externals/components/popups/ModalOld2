'use client'

import { cn } from "@/externals/utils/frontend";
import { ReactNode, useEffect, useRef } from "react";

type typeModalProps = {
  children?: ReactNode,
  show?: boolean,
  toHide: (isShow?: any) => any,
  justHidden?: boolean,
  className?: string,
}

export default function Modal({ children, show, toHide, justHidden, className }: typeModalProps) {
  const modalRef = useRef<HTMLDivElement>(null);
  const startY = useRef(0);
  const currentY = useRef(0);
  const isDragging = useRef(false);



  /**
   * Function handler
   */
  function onHide() {
    if (!modalRef.current) return;
    isDragging.current = false;
    modalRef.current.style.transform = `translateY(100%)`;
    setTimeout(() => toHide(false), 200);
  }



  /**
   * Use effect
   */
  useEffect(() => {
    function onTouchMove(e: TouchEvent) {
      if (!isDragging.current) return;
      currentY.current = e.touches[0].clientY;
      const diffY = currentY.current - startY.current;
      if (diffY > 0 && modalRef.current) {
        modalRef.current.style.transform = `translateY(${diffY}px)`;
      }
    }

    function onTouchEnd() {
      if (!modalRef.current) return;
      const diffY = currentY.current - startY.current;
      if (diffY < 120) modalRef.current.style.transform = `translateY(0)`;
      else onHide();
      isDragging.current = false;
      startY.current = 0;
      currentY.current = 0;
    }

    window.addEventListener("touchmove", onTouchMove, { passive: true });
    window.addEventListener("touchend", onTouchEnd);

    return () => {
      window.removeEventListener("touchmove", onTouchMove);
      window.removeEventListener("touchend", onTouchEnd);
    };
  }, []);

  useEffect(() => {
    if (modalRef.current) {
      if (show) {
        modalRef.current.style.transform = `translateY(0)`;
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
        modalRef.current.style.transform = `translateY(100%)`;
      }
    }

    return () => { document.body.style.overflow = ''; };
  }, [show]);



  /**
   * Render JSX
   */
  if (!(show || justHidden)) return null;
  return (
    <div
      data-identity="modal"
      onClick={(e) => { if (e.target == e.currentTarget) onHide(); }}
      className={cn('fixed inset-0 z-20 flex bg-black/30 sm:overflow-auto', { hidden: !show })}
    >
      <div
        ref={modalRef}
        className={cn(
          "max-w-2xl w-full mx-auto my-[2rem] max-sm:mt-[4rem] h-max",
          "transition-transform duration-200 ease-out touch-none sm:transform-[translateY(0)]!",
          className
        )}
      >
        <div className="h-[2.25rem] pt-2 bg-white rounded-t-2xl sm:hidden" onTouchStart={(e) => {
          startY.current = e.touches[0].clientY;
          currentY.current = startY.current;
          isDragging.current = true;
        }}><div className="w-[3rem] h-1 mx-auto bg-gray-400 rounded-full" /></div>
        <div className="card max-sm:h-[calc(100vh-6rem)] max-sm:overflow-auto">{children}</div>
      </div>
    </div>
  );
}
